<!DOCTYPE html>
<html lang="en" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systems Architecture Diagram</title>
    <link rel="icon" href="Mesob-short.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-color: #0f172a;
        --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;

        /* Layer Colors */
        --layer-institutions: #8b5cf6; /* Purple */
        --layer-gateway: #06b6d4; /* Cyan */
        --layer-microservices: #3b82f6; /* Blue */
        --layer-orchestration: #eab308; /* Gold */
        --layer-ui: #ec4899; /* Pink */

        --card-bg: rgba(255, 255, 255, 0.05);
        --card-border: rgba(255, 255, 255, 0.1);
        --card-hover: rgba(255, 255, 255, 0.1);

        --line-color: rgba(255, 255, 255, 0.2);
        --line-active: rgba(255, 255, 255, 0.6);
      }

      [data-theme='light'] {
        --bg-color: #f8fafc;
        --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --card-bg: rgba(255, 255, 255, 0.8);
        --card-border: rgba(0, 0, 0, 0.05);
        --card-hover: rgba(255, 255, 255, 1);
        --line-color: rgba(0, 0, 0, 0.1);
        --line-active: rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        transition:
          background 0.3s ease,
          color 0.3s ease;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--card-border);
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        z-index: 100;
      }

      body {
        padding-top: 72px;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
        background: none;
        -webkit-background-clip: unset;
        -webkit-text-fill-color: unset;
      }

      [data-theme='light'] .header h1 {
        color: #1d4ed8;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .page-footer {
        margin-top: auto;
        padding: 16px 40px;
        border-top: 1px solid var(--card-border);
        background: rgba(0, 0, 0, 0.08);
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      [data-theme='light'] .page-footer {
        background: rgba(0, 0, 0, 0.04);
      }

      .page-footer p {
        margin: 0;
      }

      .controls {
        display: flex;
        gap: 15px;
      }

      .theme-toggle {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
      }

      .theme-toggle:hover {
        transform: translateY(-2px);
        background: var(--card-hover);
      }

      .architecture-container {
        flex: 1;
        display: grid;
        grid-template-rows: repeat(6, auto);
        gap: 40px;
        padding: 40px;
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        width: 100%;
      }

      /* SVG Connections Background */
      .connections-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      /* Layer Styles */
      .layer {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        min-height: 120px;
      }

      .layer-label {
        position: absolute;
        left: -160px;
        width: 140px;
        text-align: right;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding-right: 20px;
        border-right: 2px solid;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
      }

      .layer-content {
        flex: 1;
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 10px;
        flex-wrap: wrap;
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 20px;
        min-width: 180px;
        max-width: 250px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        cursor: pointer;
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow:
          0 20px 25px -5px rgba(0, 0, 0, 0.2),
          0 10px 10px -5px rgba(0, 0, 0, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        z-index: 10;
      }

      .card-icon {
        font-size: 1.5rem;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card-icon-oneline {
        white-space: nowrap;
        width: auto;
        min-width: 48px;
        padding-left: 14px;
        padding-right: 14px;
      }

      .card-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
      }

      .card-subtitle {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      /* Tooltip */
      .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: #1e293b;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        width: max-content;
        max-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 20;
        margin-bottom: 10px;
      }

      [data-theme='light'] .tooltip {
        background: #334155;
      }

      .card:hover .tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
      }

      [data-theme='light'] .tooltip::after {
        border-color: #334155 transparent transparent transparent;
      }

      /* Two views: overall diagram vs orchestration detail page */
      .diagram-view {
        display: block;
        flex: 1;
        min-height: 0;
      }

      .diagram-view.hidden {
        display: none !important;
      }

      /* Orchestration detail page (separate "page") */
      .orch-page {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 0;
      }

      .orch-page-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: var(--card-bg);
        border-bottom: 2px solid var(--layer-orchestration);
        flex-shrink: 0;
      }

      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--layer-orchestration);
        color: #000;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .back-btn:hover {
        transform: translateX(-4px);
        box-shadow: 0 4px 20px rgba(234, 179, 8, 0.4);
      }

      .orch-page-title {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--layer-orchestration);
      }

      .orch-page-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px 40px 40px;
        position: relative;
        background: var(--card-bg);
        border-radius: 0 0 16px 16px;
      }

      /* Connection lines overlay (used on orchestration page) */
      .orch-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      .orch-connections path {
        stroke: var(--layer-orchestration);
        stroke-width: 1.5;
        fill: none;
        opacity: 0.35;
        transition: opacity 0.2s;
      }

      .orch-page .card.highlighted ~ * .orch-connections path {
        opacity: 0.9;
      }

      .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      /* Orchestration view: 5 layers, numbering 4.1 ‚Ä¶ 4.5, same layout as main diagram */
      .orch-page-content .architecture-container.orch-view-container {
        grid-template-rows: repeat(5, auto);
      }
      .orch-view-container .layer-label {
        font-variant-numeric: tabular-nums;
        letter-spacing: 0.5px;
      }
      .orch-view-container .layer-label span:first-child {
        font-size: 0.9rem;
        font-weight: 700;
        opacity: 0.95;
      }
      .orch-view-container .layer-label span:last-child {
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: none;
        letter-spacing: 0.3px;
        margin-top: 2px;
      }
      .orch-view-container .layer-content:has(.orch-standalone-card) {
        justify-content: center;
      }
      .orch-standalone-card {
        min-width: 220px;
        max-width: 280px;
      }

      .service-category {
        margin-bottom: 30px;
      }

      .category-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid var(--layer-orchestration);
      }

      .clickable-indicator {
        display: inline-block;
        padding: 4px 8px;
        background: var(--layer-orchestration);
        color: #000;
        font-size: 0.65rem;
        border-radius: 4px;
        font-weight: 600;
        margin-top: 5px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .card:hover .clickable-indicator {
        opacity: 1;
      }

      /* Service Interaction Styles */
      .orch-page .card {
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
      }

      .orch-page .card.highlighted {
        transform: translateY(-5px) scale(1.05);
        border-color: var(--layer-orchestration);
        box-shadow: 0 0 30px rgba(234, 179, 8, 0.4);
        z-index: 10;
      }

      .orch-page .card::before {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 14px;
        background: linear-gradient(45deg, transparent, var(--layer-orchestration), transparent);
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s;
      }

      .orch-page .card:hover::before {
        opacity: 0.3;
      }

      /* Identity / Auth detail page */
      .identity-page-bar {
        border-bottom-color: var(--layer-gateway) !important;
      }
      .identity-page-title {
        color: var(--layer-gateway) !important;
      }
      .identity-back-btn {
        background: var(--layer-gateway);
        color: #0f172a;
      }
      .identity-back-btn:hover {
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
      }
      .identity-page .category-title {
        border-left-color: var(--layer-gateway);
      }
      .identity-service-card {
        border-top: 3px solid var(--layer-gateway);
      }
      .identity-service-card:hover {
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
      }

      /* Institution detail page: services table */
      .inst-detail-bar {
        border-bottom-color: var(--layer-institutions) !important;
      }
      .inst-detail-page .orch-page-title {
        color: var(--layer-institutions) !important;
      }
      .inst-detail-page #backFromInstitutionBtn {
        background: var(--layer-institutions);
        color: #fff;
      }
      .inst-detail-page #backFromInstitutionBtn:hover {
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
      }

      /* Microservice detail page (gateway-side) */
      .ms-detail-bar {
        border-bottom-color: var(--layer-microservices) !important;
      }
      .ms-detail-page .orch-page-title {
        color: var(--layer-microservices) !important;
      }
      .ms-detail-page #backFromMicroserviceBtn {
        background: var(--layer-microservices);
        color: #fff;
      }
      .ms-detail-page #backFromMicroserviceBtn:hover {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      }
      .ms-gateway-note {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 20px;
        padding: 12px 16px;
        background: rgba(59, 130, 246, 0.08);
        border-left: 4px solid var(--layer-microservices);
        border-radius: 0 8px 8px 0;
      }

      .inst-table-wrap {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid var(--card-border);
        background: var(--card-bg);
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      }
      .inst-services-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      .inst-services-table th,
      .inst-services-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--card-border);
      }
      .inst-services-table th {
        background: rgba(139, 92, 246, 0.12);
        color: var(--text-primary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
      }
      .inst-services-table tbody tr:hover {
        background: var(--card-hover);
      }
      .inst-services-table tbody tr:last-child td {
        border-bottom: none;
      }
      .inst-services-table .endpoint {
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
        color: var(--layer-institutions);
      }
      .inst-services-table .credentials {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      /* Connection indicators */
      .service-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 10px #10b981;
        animation: pulse-badge 2s infinite;
      }

      @keyframes pulse-badge {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
      }

      /* Interaction Legend */
      .interaction-legend {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
      }

      .legend-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .legend-arrow {
        display: inline-block;
        font-size: 1rem;
        color: var(--layer-orchestration);
      }

      /* Specific Layer Styling */
      /* Layer 5: UI (Top) */
      .layer-ui .layer-label {
        color: var(--layer-ui);
        border-color: var(--layer-ui);
      }
      .layer-ui .card {
        border-top: 3px solid var(--layer-ui);
      }
      .layer-ui .card:hover {
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
      }

      /* Layer 4: Orchestration */
      .layer-orchestration .layer-label {
        color: var(--layer-orchestration);
        border-color: var(--layer-orchestration);
      }
      .layer-orchestration .card {
        border-top: 3px solid var(--layer-orchestration);
      }
      .layer-orchestration .card:hover {
        box-shadow: 0 0 20px rgba(234, 179, 8, 0.2);
      }

      /* Layer 3: Microservices */
      .layer-microservices .layer-label {
        color: var(--layer-microservices);
        border-color: var(--layer-microservices);
      }
      .layer-microservices .card {
        border-top: 3px solid var(--layer-microservices);
      }
      .layer-microservices .card:hover {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      }

      /* Layer 2: API Gateway */
      .layer-gateway .layer-label {
        color: var(--layer-gateway);
        border-color: var(--layer-gateway);
      }
      .layer-gateway .card {
        border-top: 3px solid var(--layer-gateway);
      }
      .layer-gateway .card:hover {
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
      }

      /* Layer 1: Institutions (Bottom) */
      .layer-institutions .layer-label {
        color: var(--layer-institutions);
        border-color: var(--layer-institutions);
      }
      .layer-institutions .card {
        border-top: 3px solid var(--layer-institutions);
      }
      .layer-institutions .card:hover {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      }

      /* Animation Keyframes */
      @keyframes dash {
        to {
          stroke-dashoffset: -20;
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.5);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }

      .connector-path {
        stroke: var(--line-color);
        stroke-width: 2;
        fill: none;
        transition: stroke 0.3s;
      }

      .connector-flow {
        stroke: var(--line-active);
        stroke-width: 2;
        stroke-dasharray: 5, 5;
        fill: none;
        animation: dash 1s linear infinite;
        opacity: 0.6;
      }

      /* Responsive Adjustments */
      @media (max-width: 1024px) {
        .architecture-container {
          padding: 20px;
          padding-left: 120px; /* Space for labels */
          gap: 30px;
        }
        .layer-label {
          left: -110px;
          width: 100px;
          font-size: 0.75rem;
        }
        .card {
          min-width: 140px;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body style="">
    <header class="header">
      <h1>Unified Platform Systems Architecture</h1>
      <div class="controls">
        <button class="theme-toggle" id="themeBtn">‚òÄÔ∏è Light Mode</button>
      </div>
    </header>

    <div id="view-overall" class="diagram-view">
    <div class="architecture-container" id="diagram">
      <svg class="connections-layer" id="svgLayer" xmlns="http://www.w3.org/2000/svg"><path d="M 250 750 C 250 720, 490 730, 490 700" class="connector-flow"></path><path d="M 410 750 C 410 720, 490 730, 490 700" class="connector-flow"></path><path d="M 570 750 C 570 720, 490 730, 490 700" class="connector-flow"></path><path d="M 730 750 C 730 720, 490 730, 490 700" class="connector-flow"></path><path d="M 490 570 C 490 540, 249.4375 550, 249.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 409.4375 550, 409.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 569.4375 550, 569.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 729.9921875 550, 729.9921875 520" class="connector-flow"></path><path d="M 249.4375 390 C 249.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 409.4375 390 C 409.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 569.4375 390 C 569.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 729.9921875 390 C 729.9921875 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 490 206.75 C 490 176.75, 410 190, 410 160" class="connector-flow"></path><path d="M 490 206.75 C 490 176.75, 570 190, 570 160" class="connector-flow"></path></svg>

      <!-- Layer 5: User Interface (Top) -->
      <div class="layer layer-ui" id="layer-ui">
        <div class="layer-label">
          <span>Layer 6</span>
          <span>User Interface</span>
        </div>
        <div class="layer-content">
          <div class="card" id="ui-mobile">
            <div class="card-icon">üì±</div>
            <div class="card-title">Mobile App</div>
            <div class="card-subtitle">iOS &amp; Android</div>
            <div class="tooltip">Native mobile experience</div>
          </div>
          <div class="card" id="ui-web">
            <div class="card-icon">üíª</div>
            <div class="card-title">Web Portal</div>
            <div class="card-subtitle">React Dashboard</div>
            <div class="tooltip">Responsive web interface</div>
          </div>
          <div class="card" id="ui-kiosk">
            <div class="card-icon">üñ•Ô∏è</div>
            <div class="card-title">Kiosk</div>
            <div class="card-subtitle">Self-service terminal</div>
            <div class="tooltip">On-site public kiosk access</div>
          </div>
          <div class="card" id="ui-ussd">
            <div class="card-icon">üìü</div>
            <div class="card-title">USSD</div>
            <div class="card-subtitle">Short code</div>
            <div class="tooltip">Mobile USSD for low-connectivity access</div>
          </div>
        </div>
      </div>

      <!-- Gateway: Public side (Spring Cloud Gateway) -->
      <div class="layer layer-gateway" id="layer-gw-public">
        <div class="layer-label">
          <span>Layer 5</span>
          <span>Public Entry Point</span>
        </div>
        <div class="layer-content">
          <div class="card" id="spring-cloud-gw" style="width: 300px">
            <div class="card-icon">üö™</div>
            <div class="card-title">Spring Cloud Gateway</div>
            <div class="card-subtitle">Public / Citizen access</div>
            <div class="tooltip">Routing, Rate Limiting, JWT validation, TLS</div>
          </div>
        </div>
      </div>

      <!-- Layer 4: Orchestration -->
      <div class="layer layer-orchestration" id="layer-orch">
        <div class="layer-label">
          <span>Layer 4</span>
          <span>Orchestration</span>
        </div>
        <div class="layer-content">
          <div class="card" id="orch-notif">
            <div class="card-icon">üîî</div>
            <div class="card-title">Notification</div>
            <div class="card-subtitle">Service</div>
            <div class="card-subtitle">/v2/notifications</div>
            <div class="tooltip">SMS, Email, Push alerts</div>
          </div>
          <div class="card clickable-orch" id="orch-core" style="transform: scale(1.05); border-width: 2px">
            <div class="card-icon">‚öôÔ∏è</div>
            <div class="card-title">Orchestration</div>
            <div class="card-subtitle">Core Logic</div>
            <div class="tooltip">Workflow manager & coordination</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="orch-id" style="cursor: pointer;">
            <div class="card-icon">üîê</div>
            <div class="card-title">Identity Mgmt</div>
            <div class="card-subtitle">IAM Service</div>
            <div class="tooltip">Authentication &amp; Authorization ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
        </div>
      </div>

      <!-- Layer 3: Microservices -->
      <div class="layer layer-microservices" id="layer-ms">
        <div class="layer-label">
          <span>Layer 3</span>
          <span>Microservices</span>
        </div>
        <div class="layer-content">
          <div class="card clickable-orch" id="ms-dars">
            <div class="card-icon">üìÑ</div>
            <div class="card-title">DARS Service</div>
            <div class="card-subtitle">Document Authentication & Registration</div>
            <div class="tooltip">Same services via API Six Gateway (modified address &amp; auth) ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="ms-mor">
            <div class="card-icon">üî¢</div>
            <div class="card-title">MOR Service</div>
            <div class="card-subtitle">Tax & Revenue</div>
            <div class="tooltip">Same services via API Six Gateway (modified address &amp; auth) ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="ms-nid">
            <div class="card-icon">üÜî</div>
            <div class="card-title">NID Service</div>
            <div class="card-subtitle">Identification</div>
            <div class="tooltip">Same services via API Six Gateway (modified address &amp; auth) ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="ms-motri">
            <div class="card-icon">üíº</div>
            <div class="card-title">MOTRI Service</div>
            <div class="card-subtitle">Trade & Business Registration</div>
            <div class="tooltip">Same services via API Six Gateway (modified address &amp; auth) ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
        </div>
      </div>

      <!-- Layer 2: API Gateway (Organizations side) -->
      <div class="layer layer-gateway" id="layer-gw">
        <div class="layer-label">
          <span>Layer 2</span>
          <span>Organizations</span>
        </div>
        <div class="layer-content">
          <div class="card" id="api-gw" style="width: 300px">
            <div class="card-icon">üö™</div>
            <div class="card-title">API Six Gateway</div>
            <div class="card-subtitle">Organization / Institution side</div>
            <div class="tooltip">Backend routing to DARS, MOR, NID, MOTRI</div>
          </div>
        </div>
      </div>

      <!-- Layer 1: Institutions (Bottom) -->
      <div class="layer layer-institutions" id="layer-inst">
        <div class="layer-label">
          <span>Layer 1</span>
          <span>Institutions</span>
        </div>
        <div class="layer-content">
          <div class="card clickable-orch" id="inst-dars">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">DARS</div>
            <div class="card-subtitle">Institution</div>
            <div class="tooltip">Document Authentication &amp; Registration ‚Äî Click to open services</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="inst-mor">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">MOR</div>
            <div class="card-subtitle">Institution</div>
            <div class="tooltip">Tax &amp; Revenue ‚Äî Click to open services</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="inst-nid">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">NID</div>
            <div class="card-subtitle">Institution</div>
            <div class="tooltip">National ID ‚Äî Click to open services</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="inst-motri">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">MOTRI</div>
            <div class="card-subtitle">Institution</div>
            <div class="tooltip">Trade &amp; Business Registration ‚Äî Click to open services</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Orchestration detail page ‚Äî same layout & font as main diagram (800-957) -->
    <div id="view-orchestration" class="diagram-view hidden">
      <div class="orch-page">
        <div class="orch-page-bar">
          <button type="button" class="back-btn" id="backToOverallBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title">Orchestration ‚Äî layers &amp; message flow</span>
        </div>
        <div class="orch-page-content">
          <div class="architecture-container orch-view-container">
            <!-- 4.1: Citizen & Service Management -->
            <div class="layer layer-microservices">
              <div class="layer-label">
                <span>4.1</span>
                <span>Citizen &amp; Service Mgmt</span>
              </div>
              <div class="layer-content">
                <div class="card">
                  <div class="card-icon">üìã</div>
                  <div class="card-title">Application Service</div>
                  <div class="card-subtitle">/v2/applications</div>
                  <div class="tooltip">Full lifecycle management of citizen service applications ‚Äî submit, track, approve, reject</div>
                </div>
                <div class="card">
                  <div class="card-icon">üèóÔ∏è</div>
                  <div class="card-title">Service Registry &amp; Dynamic Forms</div>
                  <div class="card-subtitle">/v2/services ¬∑ /v2/services/forms</div>
                  <div class="tooltip">190+ government services with multi-language support (am, en, or, ti), fees, and steps with dynamic forms</div>
                </div>
                <div class="card">
                  <div class="card-icon">üìÅ</div>
                  <div class="card-title">Document Management</div>
                  <div class="card-subtitle">/v2/storage</div>
                  <div class="tooltip">Scalable object storage for certificates, supporting docs, and digital assets</div>
                </div>
                <div class="card">
                  <div class="card-icon">‚úÖ</div>
                  <div class="card-title">Validation Service</div>
                  <div class="card-subtitle">/v2/validation</div>
                  <div class="tooltip">Data validation, business rule enforcement, and schema verification</div>
                </div>
              </div>
            </div>

            <!-- 4.2: Workflow Engine (Saga ¬∑ BPMN) -->
            <div class="layer layer-orchestration">
              <div class="layer-label">
                <span>4.2</span>
                <span>Workflow Engine</span>
              </div>
              <div class="layer-content">
                <div class="card">
                  <div class="card-icon">‚öôÔ∏è</div>
                  <div class="card-title">Workflow Engine</div>
                  <div class="card-subtitle">/v2/workflows</div>
                  <div class="tooltip">Distributed transactions using the Saga pattern for long-running multi-agency workflows</div>
                </div>
                <div class="card">
                  <div class="card-icon">üìê</div>
                  <div class="card-title">BPMN Versioning</div>
                  <div class="card-subtitle">/api/v2/admin/workflows/bpmn</div>
                  <div class="tooltip">Upload and manage BPMN workflow definitions with versioned deployments</div>
                </div>
                <div class="card">
                  <div class="card-icon">üîÄ</div>
                  <div class="card-title">Step Orchestrator</div>
                  <div class="card-subtitle">/api/v2/admin/workflows/steps</div>
                  <div class="tooltip">Step ordering, timeout thresholds, circuit breakers, and manual retry/resume</div>
                </div>
              </div>
            </div>


            <!-- 4.3: External Integration (Payment, Event Bus) -->
            <div class="layer layer-gateway">
              <div class="layer-label">
                <span>4.3</span>
                <span>External Integration</span>
              </div>
              <div class="layer-content">
                <div class="card">
                  <div class="card-icon">üí≥</div>
                  <div class="card-title">Payment Service</div>
                  <div class="card-subtitle">/v2/payments</div>
                  <div class="tooltip">TeleBirr, CBE Birr, bank transfers, USSD payments. PCI-DSS Level 1 compliant</div>
                </div>
                <div class="card">
                  <div class="card-icon">üîÅ</div>
                  <div class="card-title">Async Event Bus</div>
                  <div class="card-subtitle">Event Bus</div>
                  <div class="tooltip">Asynchronous callbacks and event-driven responses from ministry systems</div>
                </div>
              </div>
            </div>

            <!-- 4.4: Observability & Control -->
            <div class="layer layer-institutions">
              <div class="layer-label">
                <span>4.4</span>
                <span>Observability &amp; Control</span>
              </div>
              <div class="layer-content">
                <div class="card">
                  <div class="card-icon">üìú</div>
                  <div class="card-title">Audit Service</div>
                  <div class="card-subtitle">/v2/logs ¬∑ /api/v2/admin/audit</div>
                  <div class="tooltip">Immutable, cryptographically-signed audit trails. Legal investigation mode. Compliance exports.</div>
                </div>
                <div class="card">
                  <div class="card-icon">üìä</div>
                  <div class="card-title">Monitoring</div>
                  <div class="card-subtitle">/v2/monitoring</div>
                  <div class="tooltip">OpenTelemetry tracing, Prometheus metrics, Grafana dashboards, SLA alerts</div>
                </div>
                <div class="card">
                  <div class="card-icon">üîí</div>
                  <div class="card-title">Health &amp; Control</div>
                  <div class="card-subtitle">/api/v2/admin/health</div>
                  <div class="tooltip">Circuit breakers, traffic drain, service disabling, stalled workflow retry/resume</div>
                </div>
                <div class="card">
                  <div class="card-icon">üì¶</div>
                  <div class="card-title">ELK Stack</div>
                  <div class="card-subtitle">Internal Infrastructure</div>
                  <div class="tooltip">Centralized log management (Elasticsearch + Logstash + Kibana) for forensic analysis</div>
                </div>
              </div>
            </div>

            <!-- 4.4: Ministry Adapter (standalone) -->
            <div class="layer layer-gateway">
              <div class="layer-label">
                <span>4.4</span>
                <span>Ministry Adapter</span>
              </div>
              <div class="layer-content">
                <div class="card orch-standalone-card">
                  <div class="card-icon card-icon-oneline">üèõÔ∏è üîÅ üèõÔ∏è</div>
                  <div class="card-title">Ministry Adapter</div>
                  <div class="card-subtitle">/v2/ministry</div>
                  <div class="tooltip">Standardized integration with ministry-specific APIs and legacy government systems; translates request/response formats between platform and ministry APIs</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Institution detail page: services, endpoints, descriptions (opens when DARS/MOR/NID/MOTRI clicked) -->
    <div id="view-institution" class="diagram-view hidden">
      <div class="orch-page inst-detail-page">
        <div class="orch-page-bar inst-detail-bar">
          <button type="button" class="back-btn" id="backFromInstitutionBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title" id="instDetailTitle">Institution Services</span>
        </div>
        <div class="orch-page-content">
          <div class="inst-table-wrap">
            <table class="inst-services-table" id="instServicesTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Service</th>
                  <th>API Endpoint</th>
                  <th>Description</th>
                  <th>Credentials</th>
                </tr>
              </thead>
              <tbody id="instServicesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Microservice detail page: same services via API Six Gateway (modified address & auth) -->
    <div id="view-microservice" class="diagram-view hidden">
      <div class="orch-page ms-detail-page">
        <div class="orch-page-bar ms-detail-bar">
          <button type="button" class="back-btn" id="backFromMicroserviceBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title" id="msDetailTitle">Service ‚Äî via API Six Gateway</span>
        </div>
        <div class="orch-page-content">
          <p class="ms-gateway-note">API Six Gateway receives these requests, then translates parameters and address to the institution backend.</p>
          <div class="inst-table-wrap">
            <table class="inst-services-table" id="msServicesTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Service</th>
                  <th>API Endpoint (Gateway)</th>
                  <th>Description</th>
                  <th>Credentials (Gateway)</th>
                </tr>
              </thead>
              <tbody id="msServicesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Identity / Auth detail page (separate view) -->
    <div id="view-identity" class="diagram-view hidden">
      <div class="orch-page identity-page">
        <div class="orch-page-bar identity-page-bar">
          <button type="button" class="back-btn identity-back-btn" id="backFromIdentityBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title identity-page-title">Authentication &amp; Authorization Service</span>
        </div>
        <div class="orch-page-content">
          <div class="interaction-legend">
            <div class="legend-title">üîê Identity services</div>
            <div class="legend-item"><span class="legend-arrow">‚Üí</span> Services connected and running under Authentication &amp; Authorization</div>
          </div>

          <div class="service-category">
            <div class="category-title">Citizen Identity</div>
            <div class="services-grid">
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">ü™™</div>
                <div class="card-title">VeriFayda 2.0</div>
                <div class="card-subtitle">National biometric identity</div>
                <div class="tooltip">National biometric identity verification for Ethiopian citizens</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/verifayda</div>
              </div>
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üîë</div>
                <div class="card-title">Local Auth</div>
                <div class="card-subtitle">Email / password, OTP MFA</div>
                <div class="tooltip">Email/password login, OTP-based MFA, foreign national support</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/login</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Token &amp; Access Control</div>
            <div class="services-grid">
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üîÑ</div>
                <div class="card-title">Token Management</div>
                <div class="card-subtitle">JWT, refresh, revocation</div>
                <div class="tooltip">JWT issuance, refresh, revocation, and role-based access control</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/token</div>
              </div>
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üõ°Ô∏è</div>
                <div class="card-title">Admin Auth + MFA</div>
                <div class="card-subtitle">Privileged access</div>
                <div class="tooltip">Enhanced MFA for administrative operations and privileged access</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/api/v2/admin</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme Toggle Logic
      const themeBtn = document.getElementById('themeBtn');
      const html = document.documentElement;

      themeBtn.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        drawConnections(); // Redraw lines for new colors
      });

      // Navigate between views
      const viewOverall = document.getElementById('view-overall');
      const viewOrchestration = document.getElementById('view-orchestration');
      const viewIdentity = document.getElementById('view-identity');
      const viewInstitution = document.getElementById('view-institution');
      const viewMicroservice = document.getElementById('view-microservice');
      const orchCore = document.getElementById('orch-core');
      const orchId = document.getElementById('orch-id');
      const backToOverallBtn = document.getElementById('backToOverallBtn');
      const backFromIdentityBtn = document.getElementById('backFromIdentityBtn');
      const backFromInstitutionBtn = document.getElementById('backFromInstitutionBtn');
      const backFromMicroserviceBtn = document.getElementById('backFromMicroserviceBtn');
      const instDetailTitle = document.getElementById('instDetailTitle');
      const instServicesTableBody = document.getElementById('instServicesTableBody');
      const msDetailTitle = document.getElementById('msDetailTitle');
      const msServicesTableBody = document.getElementById('msServicesTableBody');

      const INSTITUTION_SERVICES = {
        'inst-dars': {
          name: 'DARS ‚Äî Document Authentication & Registration',
          baseUrl: 'https://192.168.10.21:8443',
          credentials: 'API Key (X-API-Key) + Client certificate (mTLS)',
          services: [
            { service: 'Minute/Resolution', endpoint: '/v2/dars/minute-resolution', description: 'Authenticating and Registering Minute/Resolution Document (Minutes/resolution of Plc. & one man plc. documents)' },
            { service: 'True Copy', endpoint: '/v2/dars/true-copy', description: 'Authentication of copies of documents against their originals (True Copy of documents)' },
            { service: 'Affidavit', endpoint: '/v2/dars/affidavit', description: 'Authenticating and registering Affidavit Document (Affidavit documents)' },
            { service: 'Memorandum of Association', endpoint: '/v2/dars/memorandum', description: 'Authenticating and Registration of Memorandum of association Document (Memorandum of association of Plc. & one man plc. documents)' },
            { service: 'Translation', endpoint: '/v2/dars/translation', description: 'Authenticating and Registration of Translation of Document (Translated documents)' },
            { service: 'Declaration', endpoint: '/v2/dars/declaration', description: 'Authenticating and Registering Declaration Document (Declaration of consent documents)' },
            { service: 'Contract Termination', endpoint: '/v2/dars/contract-termination', description: 'Termination of different contract documents' },
            { service: 'Contract Registration', endpoint: '/v2/dars/contract-register', description: 'Authenticating and registering contract documents' },
            { service: 'Power of Attorney Revocation', endpoint: '/v2/dars/power-of-attorney-revocation', description: 'Revocation/Renunciation of Power of Attorney (Revocation of Power of Attorney documents)' }
          ]
        },
        'inst-mor': {
          name: 'MOR ‚Äî Tax & Revenue',
          baseUrl: 'https://192.168.10.22:8443',
          credentials: 'OAuth2 client_credentials + TIN scope (Bearer token)',
          services: [
            { service: 'TIN Registration', endpoint: '/v2/mor/tin-registration', description: 'Application for Taxpayer Identification Number (TIN) Registration' }
          ]
        },
        'inst-nid': {
          name: 'NID ‚Äî National ID',
          baseUrl: 'https://192.168.10.23:8443',
          credentials: 'Biometric token + Organization ID (X-Org-Id header)',
          services: [
            { service: 'National ID Issuance', endpoint: '/v2/nid/issuance', description: 'National ID Issuance for Citizen Services' },
            { service: 'Grievance Handling', endpoint: '/v2/nid/grievance', description: 'Grievance handling' },
            { service: 'Geographical and Biometric Update', endpoint: '/v2/nid/update', description: 'Geographical and Biometric update' }
          ]
        },
        'inst-motri': {
          name: 'MOTRI ‚Äî Trade & Business Registration',
          baseUrl: 'https://192.168.10.24:8443',
          credentials: 'API Key + Business registration ID (X-Business-Reg-Id)',
          services: [
            { service: 'Approval of Business Organization Name', endpoint: '/v2/motri/name-approval', description: 'Approval of Business Organization Name' },
            { service: 'New Business Name Registration', endpoint: '/v2/motri/registration', description: 'New Business Name Registration' },
            { service: 'Amendment of Business Organization Name', endpoint: '/v2/motri/amendment-org-name', description: 'Amendment of Business Organization Name' },
            { service: 'Amendment of Business Name', endpoint: '/v2/motri/amendment-name', description: 'Amendment of Business Name' },
            { service: 'Replacement of Business Registration Certificate', endpoint: '/v2/motri/replacement-certificate', description: 'Replacement of Business Registration Certificate' },
            { service: 'Replacement of Business License', endpoint: '/v2/motri/replacement-license', description: 'Replacement of Business License' },
            { service: 'Replacement of Business Name Certificate', endpoint: '/v2/motri/replacement-name-cert', description: 'Replacement of Business Name Certificate' },
            { service: 'Cancellation of Business License', endpoint: '/v2/motri/cancellation-license', description: 'Cancellation of Business License' },
            { service: 'Cancellation of Business Name', endpoint: '/v2/motri/cancellation-name', description: 'Cancellation of Business Name' },
            { service: 'Cancellation of Business Registration', endpoint: '/v2/motri/cancellation-registration', description: 'Cancellation of Business Registration' }
          ]
        }
      };

      // Same services as above, but via API Six Gateway (modified address & auth for platform ‚Üí institution)
      const MICROSERVICE_SERVICES = {
        'ms-dars': {
          name: 'DARS Service ‚Äî via API Six Gateway',
          baseUrl: 'https://192.168.1.10:443',
          credentials: 'JWT Bearer (platform) + X-Org-Id ‚Äî Gateway translates to institution API Key + mTLS',
          services: [
            { service: 'Minute/Resolution', endpoint: '/v2/dars/minute-resolution', description: 'Authenticating and Registering Minute/Resolution Document (Minutes/resolution of Plc. & one man plc. documents)' },
            { service: 'True Copy', endpoint: '/v2/dars/true-copy', description: 'Authentication of copies of documents against their originals (True Copy of documents)' },
            { service: 'Affidavit', endpoint: '/v2/dars/affidavit', description: 'Authenticating and registering Affidavit Document (Affidavit documents)' },
            { service: 'Memorandum of Association', endpoint: '/v2/dars/memorandum', description: 'Authenticating and Registration of Memorandum of association Document (Memorandum of association of Plc. & one man plc. documents)' },
            { service: 'Translation', endpoint: '/v2/dars/translation', description: 'Authenticating and Registration of Translation of Document (Translated documents)' },
            { service: 'Declaration', endpoint: '/v2/dars/declaration', description: 'Authenticating and Registering Declaration Document (Declaration of consent documents)' },
            { service: 'Contract Termination', endpoint: '/v2/dars/contract-termination', description: 'Termination of different contract documents' },
            { service: 'Contract Registration', endpoint: '/v2/dars/contract-register', description: 'Authenticating and registering contract documents' },
            { service: 'Power of Attorney Revocation', endpoint: '/v2/dars/power-of-attorney-revocation', description: 'Revocation/Renunciation of Power of Attorney (Revocation of Power of Attorney documents)' }
          ]
        },
        'ms-mor': {
          name: 'MOR Service ‚Äî via API Six Gateway',
          baseUrl: 'https://192.168.1.10:443',
          credentials: 'JWT Bearer (platform) + X-Org-Id ‚Äî Gateway translates to OAuth2 + TIN scope for institution',
          services: [
            { service: 'TIN Registration', endpoint: '/v2/mor/tin-registration', description: 'Application for Taxpayer Identification Number (TIN) Registration' }
          ]
        },
        'ms-nid': {
          name: 'NID Service ‚Äî via API Six Gateway',
          baseUrl: 'https://192.168.1.10:443',
          credentials: 'JWT Bearer (platform) + X-Org-Id ‚Äî Gateway translates to Biometric token + Org ID for institution',
          services: [
            { service: 'National ID Issuance', endpoint: '/v2/nid/issuance', description: 'National ID Issuance for Citizen Services' },
            { service: 'Grievance Handling', endpoint: '/v2/nid/grievance', description: 'Grievance handling' },
            { service: 'Geographical and Biometric Update', endpoint: '/v2/nid/update', description: 'Geographical and Biometric update' }
          ]
        },
        'ms-motri': {
          name: 'MOTRI Service ‚Äî via API Six Gateway',
          baseUrl: 'https://192.168.1.10:443',
          credentials: 'JWT Bearer (platform) + X-Org-Id ‚Äî Gateway translates to API Key + Business Reg ID for institution',
          services: [
            { service: 'Approval of Business Organization Name', endpoint: '/v2/motri/name-approval', description: 'Approval of Business Organization Name' },
            { service: 'New Business Name Registration', endpoint: '/v2/motri/registration', description: 'New Business Name Registration' },
            { service: 'Amendment of Business Organization Name', endpoint: '/v2/motri/amendment-org-name', description: 'Amendment of Business Organization Name' },
            { service: 'Amendment of Business Name', endpoint: '/v2/motri/amendment-name', description: 'Amendment of Business Name' },
            { service: 'Replacement of Business Registration Certificate', endpoint: '/v2/motri/replacement-certificate', description: 'Replacement of Business Registration Certificate' },
            { service: 'Replacement of Business License', endpoint: '/v2/motri/replacement-license', description: 'Replacement of Business License' },
            { service: 'Replacement of Business Name Certificate', endpoint: '/v2/motri/replacement-name-cert', description: 'Replacement of Business Name Certificate' },
            { service: 'Cancellation of Business License', endpoint: '/v2/motri/cancellation-license', description: 'Cancellation of Business License' },
            { service: 'Cancellation of Business Name', endpoint: '/v2/motri/cancellation-name', description: 'Cancellation of Business Name' },
            { service: 'Cancellation of Business Registration', endpoint: '/v2/motri/cancellation-registration', description: 'Cancellation of Business Registration' }
          ]
        }
      };

      function showInstitutionPage(instId) {
        viewOverall.classList.add('hidden');
        viewOrchestration.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewMicroservice.classList.add('hidden');
        viewInstitution.classList.remove('hidden');
        const data = INSTITUTION_SERVICES[instId];
        if (!data || !instDetailTitle || !instServicesTableBody) return;
        instDetailTitle.textContent = data.name;
        const baseUrl = data.baseUrl || '';
        instServicesTableBody.innerHTML = data.services.map((row, i) => {
          const fullEndpoint = baseUrl + row.endpoint;
          return '<tr><td>' + (i + 1) + '</td><td>' + escapeHtml(row.service) + '</td><td><code class="endpoint">' + escapeHtml(fullEndpoint) + '</code></td><td>' + escapeHtml(row.description) + '</td><td class="credentials">' + escapeHtml(data.credentials) + '</td></tr>';
        }).join('');
      }

      function showMicroservicePage(msId) {
        viewOverall.classList.add('hidden');
        viewOrchestration.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewInstitution.classList.add('hidden');
        viewMicroservice.classList.remove('hidden');
        const data = MICROSERVICE_SERVICES[msId];
        if (!data || !msDetailTitle || !msServicesTableBody) return;
        msDetailTitle.textContent = data.name;
        const baseUrl = data.baseUrl || '';
        msServicesTableBody.innerHTML = data.services.map((row, i) => {
          const fullEndpoint = baseUrl + row.endpoint;
          return '<tr><td>' + (i + 1) + '</td><td>' + escapeHtml(row.service) + '</td><td><code class="endpoint">' + escapeHtml(fullEndpoint) + '</code></td><td>' + escapeHtml(row.description) + '</td><td class="credentials">' + escapeHtml(data.credentials) + '</td></tr>';
        }).join('');
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function showOrchestrationPage() {
        viewOverall.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewInstitution.classList.add('hidden');
        viewMicroservice.classList.add('hidden');
        viewOrchestration.classList.remove('hidden');
        setTimeout(drawOrchConnections, 200);
      }

      function showIdentityPage() {
        viewOverall.classList.add('hidden');
        viewOrchestration.classList.add('hidden');
        viewInstitution.classList.add('hidden');
        viewMicroservice.classList.add('hidden');
        viewIdentity.classList.remove('hidden');
      }

      function showOverallPage() {
        viewOrchestration.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewInstitution.classList.add('hidden');
        viewMicroservice.classList.add('hidden');
        viewOverall.classList.remove('hidden');
      }

      orchCore.addEventListener('click', (e) => {
        e.stopPropagation();
        showOrchestrationPage();
      });

      if (orchId) {
        orchId.addEventListener('click', (e) => {
          e.stopPropagation();
          showIdentityPage();
        });
      }

      ['inst-dars', 'inst-mor', 'inst-nid', 'inst-motri'].forEach(instId => {
        const el = document.getElementById(instId);
        if (el) {
          el.style.cursor = 'pointer';
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            showInstitutionPage(instId);
          });
        }
      });

      ['ms-dars', 'ms-mor', 'ms-nid', 'ms-motri'].forEach(msId => {
        const el = document.getElementById(msId);
        if (el) {
          el.style.cursor = 'pointer';
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            showMicroservicePage(msId);
          });
        }
      });

      if (backToOverallBtn) {
        backToOverallBtn.addEventListener('click', showOverallPage);
      }
      if (backFromIdentityBtn) {
        backFromIdentityBtn.addEventListener('click', showOverallPage);
      }
      if (backFromInstitutionBtn) {
        backFromInstitutionBtn.addEventListener('click', showOverallPage);
      }
      if (backFromMicroserviceBtn) {
        backFromMicroserviceBtn.addEventListener('click', showOverallPage);
      }

      // Draw connection lines between services on orchestration page
      function drawOrchConnections() {
        const svg = document.getElementById('orchConnectionsSvg');
        const container = document.querySelector('.orch-page-content');
        if (!svg || !container) return;
        const rect = container.getBoundingClientRect();
        svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        svg.setAttribute('width', rect.width);
        svg.setAttribute('height', rect.height);
        const cards = container.querySelectorAll('.card[data-service][data-connects-to]');
        const idToPos = new Map();
        cards.forEach(card => {
          const r = card.getBoundingClientRect();
          const cx = r.left - rect.left + r.width / 2;
          const cy = r.top - rect.top + r.height / 2;
          idToPos.set(card.getAttribute('data-service'), { x: cx, y: cy });
        });
        const drawn = new Set();
        let pathD = '';
        cards.forEach(card => {
          const fromId = card.getAttribute('data-service');
          const toIds = (card.getAttribute('data-connects-to') || '').split(',');
          const from = idToPos.get(fromId);
          if (!from) return;
          toIds.forEach(toId => {
            const key = [fromId, toId.trim()].sort().join('-');
            if (drawn.has(key)) return;
            const to = idToPos.get(toId.trim());
            if (!to) return;
            drawn.add(key);
            const midX = (from.x + to.x) / 2;
            pathD += `M ${from.x} ${from.y} C ${midX} ${from.y}, ${midX} ${to.y}, ${to.x} ${to.y} `;
          });
        });
        svg.innerHTML = '<path d="' + pathD + '" fill="none" stroke-width="1.5" opacity="0.35"/>';
      }

      // Service connection highlighting (hover) on orchestration page
      function setupServiceInteractions() {
        const serviceCards = document.querySelectorAll('.orch-page .card[data-service]');
        serviceCards.forEach(card => {
          card.addEventListener('mouseenter', () => {
            card.classList.add('highlighted');
            const connectsTo = card.getAttribute('data-connects-to');
            if (connectsTo) {
              connectsTo.split(',').forEach(connectedId => {
                const connectedCard = document.querySelector(`.orch-page .card[data-service="${connectedId.trim()}"]`);
                if (connectedCard) connectedCard.classList.add('highlighted');
              });
            }
          });
          card.addEventListener('mouseleave', () => {
            serviceCards.forEach(c => c.classList.remove('highlighted'));
          });
        });
      }
      setupServiceInteractions();

      // Connection Drawing Logic
      function drawLine(svg, startElem, endElem, colorClass) {
        const startRect = startElem.getBoundingClientRect();
        const endRect = endElem.getBoundingClientRect();
        const containerRect = document.querySelector('.architecture-container').getBoundingClientRect();

        // Calculate relative coordinates
        const x1 = startRect.left + startRect.width / 2 - containerRect.left;
        const y1 = startRect.top - containerRect.top; // Top of start element
        const x2 = endRect.left + endRect.width / 2 - containerRect.left;
        const y2 = endRect.bottom - containerRect.top; // Bottom of end element (since we draw bottom-up visual but code is top-down logic usually, let's adjust)

        // Actually, we want lines from bottom layers UP to top layers.
        // Start: Top of bottom element
        // End: Bottom of top element

        // Let's redefine: startElem is the LOWER element, endElem is the UPPER element
        const startX = startRect.left + startRect.width / 2 - containerRect.left;
        const startY = startRect.top - containerRect.top; // Top edge of lower card

        const endX = endRect.left + endRect.width / 2 - containerRect.left;
        const endY = endRect.bottom - containerRect.top; // Bottom edge of upper card

        // Create Path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

        // Bezier curve control points
        const controlY1 = startY - 30;
        const controlY2 = endY + 30;

        const d = `M ${startX} ${startY} C ${startX} ${controlY1}, ${endX} ${controlY2}, ${endX} ${endY}`;

        path.setAttribute('d', d);
        path.classList.add('connector-flow');
        // path.setAttribute("marker-end", "url(#arrowhead)"); // Optional arrow

        svg.appendChild(path);
      }

      function drawConnections() {
        const svg = document.getElementById('svgLayer');
        svg.innerHTML = ''; // Clear previous lines

        const springGw = document.getElementById('spring-cloud-gw');
        const apiSixGw = document.getElementById('api-gw');
        const instIds = ['inst-dars', 'inst-mor', 'inst-nid', 'inst-motri'];
        const msIds = ['ms-dars', 'ms-mor', 'ms-nid', 'ms-motri'];
        const orchCore = document.getElementById('orch-core');
        const uiMobile = document.getElementById('ui-mobile');
        const uiWeb = document.getElementById('ui-web');

        // 1. Institutions -> API Six Gateway (organizations side)
        instIds.forEach((id) => {
          const inst = document.getElementById(id);
          if (inst && apiSixGw) drawLine(svg, inst, apiSixGw);
        });

        // 2. API Six Gateway -> Microservices
        msIds.forEach((id) => {
          const ms = document.getElementById(id);
          if (apiSixGw && ms) drawLine(svg, apiSixGw, ms);
        });

        // 3. Microservices -> Orchestration Core
        msIds.forEach((id) => {
          const ms = document.getElementById(id);
          if (ms && orchCore) drawLine(svg, ms, orchCore);
        });

        // 4. Orchestration Core -> Spring Cloud Gateway (public side)
        if (orchCore && springGw) drawLine(svg, orchCore, springGw);

        // 5. Spring Cloud Gateway -> Identity Mgmt & Notification
        const orchId = document.getElementById('orch-id');
        const orchNotif = document.getElementById('orch-notif');
        if (springGw && orchId) drawLine(svg, springGw, orchId);
        if (springGw && orchNotif) drawLine(svg, springGw, orchNotif);

        // 6. Spring Cloud Gateway -> UI (Mobile, Web, Kiosk, USSD)
        const uiKiosk = document.getElementById('ui-kiosk');
        const uiUssd = document.getElementById('ui-ussd');
        if (springGw && uiMobile) drawLine(svg, springGw, uiMobile);
        if (springGw && uiWeb) drawLine(svg, springGw, uiWeb);
        if (springGw && uiKiosk) drawLine(svg, springGw, uiKiosk);
        if (springGw && uiUssd) drawLine(svg, springGw, uiUssd);
      }

      // Handle resize
      window.addEventListener('resize', drawConnections);

      // Initial Draw
      // Small delay to ensure layout is done
      setTimeout(drawConnections, 100);
    </script>

    <footer class="page-footer">
      <p>¬© Ethiopian Artificial Intelligence Institute ‚Äî Last update Feb 22, 2026</p>
    </footer>
  </body>
</html>