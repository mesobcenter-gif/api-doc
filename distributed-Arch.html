<!DOCTYPE html>
<html lang="en" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systems Architecture Diagram</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-color: #0f172a;
        --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;

        /* Layer Colors */
        --layer-institutions: #8b5cf6; /* Purple */
        --layer-gateway: #06b6d4; /* Cyan */
        --layer-microservices: #3b82f6; /* Blue */
        --layer-orchestration: #eab308; /* Gold */
        --layer-ui: #ec4899; /* Pink */

        --card-bg: rgba(255, 255, 255, 0.05);
        --card-border: rgba(255, 255, 255, 0.1);
        --card-hover: rgba(255, 255, 255, 0.1);

        --line-color: rgba(255, 255, 255, 0.2);
        --line-active: rgba(255, 255, 255, 0.6);
      }

      [data-theme='light'] {
        --bg-color: #f8fafc;
        --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --card-bg: rgba(255, 255, 255, 0.8);
        --card-border: rgba(0, 0, 0, 0.05);
        --card-hover: rgba(255, 255, 255, 1);
        --line-color: rgba(0, 0, 0, 0.1);
        --line-active: rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        transition:
          background 0.3s ease,
          color 0.3s ease;
      }

      .header {
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--card-border);
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        z-index: 100;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(to right, var(--layer-ui), var(--layer-gateway));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .controls {
        display: flex;
        gap: 15px;
      }

      .theme-toggle {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
      }

      .theme-toggle:hover {
        transform: translateY(-2px);
        background: var(--card-hover);
      }

      .architecture-container {
        flex: 1;
        display: grid;
        grid-template-rows: repeat(6, auto);
        gap: 40px;
        padding: 40px;
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        width: 100%;
      }

      /* SVG Connections Background */
      .connections-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      /* Layer Styles */
      .layer {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        min-height: 120px;
      }

      .layer-label {
        position: absolute;
        left: -160px;
        width: 140px;
        text-align: right;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding-right: 20px;
        border-right: 2px solid;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
      }

      .layer-content {
        flex: 1;
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 10px;
        flex-wrap: wrap;
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 20px;
        min-width: 180px;
        max-width: 250px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        cursor: pointer;
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow:
          0 20px 25px -5px rgba(0, 0, 0, 0.2),
          0 10px 10px -5px rgba(0, 0, 0, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        z-index: 10;
      }

      .card-icon {
        font-size: 1.5rem;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
      }

      .card-subtitle {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      /* Tooltip */
      .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: #1e293b;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        width: max-content;
        max-width: 200px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 20;
        margin-bottom: 10px;
      }

      [data-theme='light'] .tooltip {
        background: #334155;
      }

      .card:hover .tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
      }

      [data-theme='light'] .tooltip::after {
        border-color: #334155 transparent transparent transparent;
      }

      /* Two views: overall diagram vs orchestration detail page */
      .diagram-view {
        display: block;
        flex: 1;
        min-height: 0;
      }

      .diagram-view.hidden {
        display: none !important;
      }

      /* Orchestration detail page (separate "page") */
      .orch-page {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 0;
      }

      .orch-page-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: var(--card-bg);
        border-bottom: 2px solid var(--layer-orchestration);
        flex-shrink: 0;
      }

      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--layer-orchestration);
        color: #000;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .back-btn:hover {
        transform: translateX(-4px);
        box-shadow: 0 4px 20px rgba(234, 179, 8, 0.4);
      }

      .orch-page-title {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--layer-orchestration);
      }

      .orch-page-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px 40px 40px;
        position: relative;
        background: var(--card-bg);
        border-radius: 0 0 16px 16px;
      }

      /* Connection lines overlay (used on orchestration page) */
      .orch-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      .orch-connections path {
        stroke: var(--layer-orchestration);
        stroke-width: 1.5;
        fill: none;
        opacity: 0.35;
        transition: opacity 0.2s;
      }

      .orch-page .card.highlighted ~ * .orch-connections path {
        opacity: 0.9;
      }

      .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .service-category {
        margin-bottom: 30px;
      }

      .category-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid var(--layer-orchestration);
      }

      .clickable-indicator {
        display: inline-block;
        padding: 4px 8px;
        background: var(--layer-orchestration);
        color: #000;
        font-size: 0.65rem;
        border-radius: 4px;
        font-weight: 600;
        margin-top: 5px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .card:hover .clickable-indicator {
        opacity: 1;
      }

      /* Service Interaction Styles */
      .orch-page .card {
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
      }

      .orch-page .card.highlighted {
        transform: translateY(-5px) scale(1.05);
        border-color: var(--layer-orchestration);
        box-shadow: 0 0 30px rgba(234, 179, 8, 0.4);
        z-index: 10;
      }

      .orch-page .card::before {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 14px;
        background: linear-gradient(45deg, transparent, var(--layer-orchestration), transparent);
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s;
      }

      .orch-page .card:hover::before {
        opacity: 0.3;
      }

      /* Identity / Auth detail page */
      .identity-page-bar {
        border-bottom-color: var(--layer-gateway) !important;
      }
      .identity-page-title {
        color: var(--layer-gateway) !important;
      }
      .identity-back-btn {
        background: var(--layer-gateway);
        color: #0f172a;
      }
      .identity-back-btn:hover {
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
      }
      .identity-page .category-title {
        border-left-color: var(--layer-gateway);
      }
      .identity-service-card {
        border-top: 3px solid var(--layer-gateway);
      }
      .identity-service-card:hover {
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
      }

      /* Connection indicators */
      .service-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 10px #10b981;
        animation: pulse-badge 2s infinite;
      }

      @keyframes pulse-badge {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
      }

      /* Interaction Legend */
      .interaction-legend {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
      }

      .legend-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .legend-arrow {
        display: inline-block;
        font-size: 1rem;
        color: var(--layer-orchestration);
      }

      /* Specific Layer Styling */
      /* Layer 5: UI (Top) */
      .layer-ui .layer-label {
        color: var(--layer-ui);
        border-color: var(--layer-ui);
      }
      .layer-ui .card {
        border-top: 3px solid var(--layer-ui);
      }
      .layer-ui .card:hover {
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
      }

      /* Layer 4: Orchestration */
      .layer-orchestration .layer-label {
        color: var(--layer-orchestration);
        border-color: var(--layer-orchestration);
      }
      .layer-orchestration .card {
        border-top: 3px solid var(--layer-orchestration);
      }
      .layer-orchestration .card:hover {
        box-shadow: 0 0 20px rgba(234, 179, 8, 0.2);
      }

      /* Layer 3: Microservices */
      .layer-microservices .layer-label {
        color: var(--layer-microservices);
        border-color: var(--layer-microservices);
      }
      .layer-microservices .card {
        border-top: 3px solid var(--layer-microservices);
      }
      .layer-microservices .card:hover {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
      }

      /* Layer 2: API Gateway */
      .layer-gateway .layer-label {
        color: var(--layer-gateway);
        border-color: var(--layer-gateway);
      }
      .layer-gateway .card {
        border-top: 3px solid var(--layer-gateway);
      }
      .layer-gateway .card:hover {
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
      }

      /* Layer 1: Institutions (Bottom) */
      .layer-institutions .layer-label {
        color: var(--layer-institutions);
        border-color: var(--layer-institutions);
      }
      .layer-institutions .card {
        border-top: 3px solid var(--layer-institutions);
      }
      .layer-institutions .card:hover {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      }

      /* Animation Keyframes */
      @keyframes dash {
        to {
          stroke-dashoffset: -20;
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.5);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }

      .connector-path {
        stroke: var(--line-color);
        stroke-width: 2;
        fill: none;
        transition: stroke 0.3s;
      }

      .connector-flow {
        stroke: var(--line-active);
        stroke-width: 2;
        stroke-dasharray: 5, 5;
        fill: none;
        animation: dash 1s linear infinite;
        opacity: 0.6;
      }

      /* Responsive Adjustments */
      @media (max-width: 1024px) {
        .architecture-container {
          padding: 20px;
          padding-left: 120px; /* Space for labels */
          gap: 30px;
        }
        .layer-label {
          left: -110px;
          width: 100px;
          font-size: 0.75rem;
        }
        .card {
          min-width: 140px;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body style="">
    <header class="header">
      <h1>Unified Platform Systems Architecture</h1>
      <div class="controls">
        <button class="theme-toggle" id="themeBtn">‚òÄÔ∏è Light Mode</button>
      </div>
    </header>

    <div id="view-overall" class="diagram-view">
    <div class="architecture-container" id="diagram">
      <svg class="connections-layer" id="svgLayer" xmlns="http://www.w3.org/2000/svg"><path d="M 250 750 C 250 720, 490 730, 490 700" class="connector-flow"></path><path d="M 410 750 C 410 720, 490 730, 490 700" class="connector-flow"></path><path d="M 570 750 C 570 720, 490 730, 490 700" class="connector-flow"></path><path d="M 730 750 C 730 720, 490 730, 490 700" class="connector-flow"></path><path d="M 490 570 C 490 540, 249.4375 550, 249.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 409.4375 550, 409.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 569.4375 550, 569.4375 520" class="connector-flow"></path><path d="M 490 570 C 490 540, 729.9921875 550, 729.9921875 520" class="connector-flow"></path><path d="M 249.4375 390 C 249.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 409.4375 390 C 409.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 569.4375 390 C 569.4375 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 729.9921875 390 C 729.9921875 360, 490 373.25, 490 343.25" class="connector-flow"></path><path d="M 490 206.75 C 490 176.75, 410 190, 410 160" class="connector-flow"></path><path d="M 490 206.75 C 490 176.75, 570 190, 570 160" class="connector-flow"></path></svg>

      <!-- Layer 5: User Interface (Top) -->
      <div class="layer layer-ui" id="layer-ui">
        <div class="layer-label">
          <span>Layer 5</span>
          <span>User Interface</span>
        </div>
        <div class="layer-content">
          <div class="card" id="ui-mobile">
            <div class="card-icon">üì±</div>
            <div class="card-title">Mobile App</div>
            <div class="card-subtitle">iOS &amp; Android</div>
            <div class="tooltip">Native mobile experience</div>
          </div>
          <div class="card" id="ui-web">
            <div class="card-icon">üíª</div>
            <div class="card-title">Web Portal</div>
            <div class="card-subtitle">React Dashboard</div>
            <div class="tooltip">Responsive web interface</div>
          </div>
          <div class="card" id="ui-kiosk">
            <div class="card-icon">üñ•Ô∏è</div>
            <div class="card-title">Kiosk</div>
            <div class="card-subtitle">Self-service terminal</div>
            <div class="tooltip">On-site public kiosk access</div>
          </div>
          <div class="card" id="ui-ussd">
            <div class="card-icon">üìü</div>
            <div class="card-title">USSD</div>
            <div class="card-subtitle">Short code</div>
            <div class="tooltip">Mobile USSD for low-connectivity access</div>
          </div>
        </div>
      </div>

      <!-- Gateway: Public side (Spring Cloud Gateway) -->
      <div class="layer layer-gateway" id="layer-gw-public">
        <div class="layer-label">
          <span>Public</span>
          <span>Entry</span>
        </div>
        <div class="layer-content">
          <div class="card" id="spring-cloud-gw" style="width: 300px">
            <div class="card-icon">üö™</div>
            <div class="card-title">Spring Cloud Gateway</div>
            <div class="card-subtitle">Public / Citizen access</div>
            <div class="tooltip">Routing, Rate Limiting, JWT validation, TLS</div>
          </div>
        </div>
      </div>

      <!-- Layer 4: Orchestration -->
      <div class="layer layer-orchestration" id="layer-orch">
        <div class="layer-label">
          <span>Layer 4</span>
          <span>Orchestration</span>
        </div>
        <div class="layer-content">
          <div class="card" id="orch-notif">
            <div class="card-icon">üîî</div>
            <div class="card-title">Notification</div>
            <div class="card-subtitle">Service</div>
            <div class="tooltip">SMS, Email, Push alerts</div>
          </div>
          <div class="card clickable-orch" id="orch-core" style="transform: scale(1.05); border-width: 2px">
            <div class="card-icon">‚öôÔ∏è</div>
            <div class="card-title">Orchestration</div>
            <div class="card-subtitle">Core Logic</div>
            <div class="tooltip">Workflow manager & coordination</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
          <div class="card clickable-orch" id="orch-id" style="cursor: pointer;">
            <div class="card-icon">üîê</div>
            <div class="card-title">Identity Mgmt</div>
            <div class="card-subtitle">IAM Service</div>
            <div class="tooltip">Authentication &amp; Authorization ‚Äî Click to open</div>
            <div class="clickable-indicator">Click to open</div>
          </div>
        </div>
      </div>

      <!-- Layer 3: Microservices -->
      <div class="layer layer-microservices" id="layer-ms">
        <div class="layer-label">
          <span>Layer 3</span>
          <span>Microservices</span>
        </div>
        <div class="layer-content">
          <div class="card" id="ms-dars">
            <div class="card-icon">üìÑ</div>
            <div class="card-title">DARS Service</div>
            <div class="card-subtitle">Document Authentication & Registration</div>
            <div class="tooltip">Power of Attorney revocation; Contract amendment & termination; Declaration, Translation, Affidavit, True Copy; Memorandum of Association; Minute/Resolution (9 services)</div>
          </div>
          <div class="card" id="ms-mor">
            <div class="card-icon">üî¢</div>
            <div class="card-title">MOR Service</div>
            <div class="card-subtitle">Tax & Revenue</div>
            <div class="tooltip">Application for Taxpayer Identification Number (TIN) Registration ‚Äî free, 30‚Äì45 min</div>
          </div>
          <div class="card" id="ms-nid">
            <div class="card-icon">üÜî</div>
            <div class="card-title">NID Service</div>
            <div class="card-subtitle">Identification</div>
            <div class="tooltip">National ID Verification</div>
          </div>
          <div class="card" id="ms-motri">
            <div class="card-icon">üíº</div>
            <div class="card-title">MOTRI Service</div>
            <div class="card-subtitle">Trade & Business Registration</div>
            <div class="tooltip">Business name approval, registration, amendment; Certificate & license replacement; Cancellation of license, name, registration (10 services)</div>
          </div>
        </div>
      </div>

      <!-- Layer 2: API Gateway (Organizations side) -->
      <div class="layer layer-gateway" id="layer-gw">
        <div class="layer-label">
          <span>Layer 2</span>
          <span>Organizations</span>
        </div>
        <div class="layer-content">
          <div class="card" id="api-gw" style="width: 300px">
            <div class="card-icon">üö™</div>
            <div class="card-title">API Six Gateway</div>
            <div class="card-subtitle">Organization / Institution side</div>
            <div class="tooltip">Backend routing to DARS, MOR, NID, MOTRI</div>
          </div>
        </div>
      </div>

      <!-- Layer 1: Institutions (Bottom) -->
      <div class="layer layer-institutions" id="layer-inst">
        <div class="layer-label">
          <span>Layer 1</span>
          <span>Institutions</span>
        </div>
        <div class="layer-content">
          <div class="card" id="inst-dars">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">DARS</div>
            <div class="card-subtitle">Institution</div>
          </div>
          <div class="card" id="inst-mor">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">MOR</div>
            <div class="card-subtitle">Institution</div>
          </div>
          <div class="card" id="inst-nid">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">NID</div>
            <div class="card-subtitle">Institution</div>
          </div>
          <div class="card" id="inst-motri">
            <div class="card-icon">üèõÔ∏è</div>
            <div class="card-title">MOTRI</div>
            <div class="card-subtitle">Institution</div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Orchestration detail page (separate view) -->
    <div id="view-orchestration" class="diagram-view hidden">
      <div class="orch-page">
        <div class="orch-page-bar">
          <button type="button" class="back-btn" id="backToOverallBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title">Orchestration Core (Brain) ‚Äî services & connections</span>
        </div>
        <div class="orch-page-content">
          <svg class="orch-connections" id="orchConnectionsSvg" xmlns="http://www.w3.org/2000/svg"></svg>
          <div class="interaction-legend">
            <div class="legend-title">üîó Service connections</div>
            <div class="legend-item"><span class="legend-arrow">‚Üí</span> Hover a service to highlight its connections</div>
          </div>

          <div class="service-category">
            <div class="category-title">Orchestration Core (Brain)</div>
            <div class="services-grid">
              <div class="card" data-service="workflow" data-connects-to="saga-state,circuit-breaker,audit-logger,error-handler,request-queue">
                <span class="service-badge"></span>
                <div class="card-icon">‚öôÔ∏è</div>
                <div class="card-title">Workflow Engine</div>
                <div class="card-subtitle">Saga orchestration</div>
                <div class="tooltip">Controls saga steps ¬∑ Manages transitions ¬∑ Triggers compensation ¬∑ Handles timeouts</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Database & object storage</div>
            <div class="services-grid">
              <div class="card" data-service="storage" data-connects-to="saga-state">
                <span class="service-badge"></span>
                <div class="card-icon">üóÑÔ∏è</div>
                <div class="card-title">Database & Object Storage</div>
                <div class="card-subtitle">Persistence</div>
                <div class="tooltip">Backing store for saga state and workflow data</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">State & Data Management (Memory and Protection)</div>
            <div class="services-grid">
              <div class="card" data-service="saga-state" data-connects-to="workflow,storage">
                <span class="service-badge"></span>
                <div class="card-icon">üíæ</div>
                <div class="card-title">Saga State Manager</div>
                <div class="card-subtitle">Workflow state</div>
                <div class="tooltip">Stores: Workflow ID ¬∑ Current step ¬∑ Status ¬∑ Compensation status ¬∑ Correlation ID ¬∑ Retry count</div>
              </div>
              <div class="card" data-service="circuit-breaker" data-connects-to="workflow,error-handler">
                <span class="service-badge"></span>
                <div class="card-icon">‚ö°</div>
                <div class="card-title">Circuit Breaker</div>
                <div class="card-subtitle">Resilience</div>
                <div class="tooltip">Prevents cascading failure ¬∑ Protects orchestrator ¬∑ Retry policy ¬∑ Timeout management ¬∑ Bulkhead isolation</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Security & Access Control</div>
            <div class="services-grid">
              <div class="card" data-service="api-key" data-connects-to="audit-logger">
                <span class="service-badge"></span>
                <div class="card-icon">üîë</div>
                <div class="card-title">API Key Manager</div>
                <div class="card-subtitle">Access control</div>
                <div class="tooltip">Organization-level isolation</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Observability & Control</div>
            <div class="services-grid">
              <div class="card" data-service="audit-logger" data-connects-to="workflow,error-handler,api-key">
                <span class="service-badge"></span>
                <div class="card-icon">üìú</div>
                <div class="card-title">Audit Logger</div>
                <div class="card-subtitle">Traceability</div>
                <div class="tooltip">Who initiated request ¬∑ When ¬∑ What step executed ¬∑ What data changed ¬∑ Compensation events</div>
              </div>
              <div class="card" data-service="error-handler" data-connects-to="workflow,circuit-breaker,audit-logger">
                <span class="service-badge"></span>
                <div class="card-icon">üö®</div>
                <div class="card-title">Error Handler</div>
                <div class="card-subtitle">Failure handling</div>
                <div class="tooltip">Classify errors (transient vs permanent) ¬∑ Decide retry vs compensate ¬∑ Trigger alerts</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Integration & Communication</div>
            <div class="services-grid">
              <div class="card" data-service="request-queue" data-connects-to="workflow,format-adapter">
                <span class="service-badge"></span>
                <div class="card-icon">üì°</div>
                <div class="card-title">Request Queue (between organizations)</div>
                <div class="card-subtitle">Kafka, RabbitMQ</div>
                <div class="tooltip">Makes the saga: Asynchronous ¬∑ Resilient ¬∑ Loosely coupled</div>
              </div>
              <div class="card" data-service="format-adapter" data-connects-to="request-queue">
                <span class="service-badge"></span>
                <div class="card-icon">üîÑ</div>
                <div class="card-title">Request/Response Format Adapter</div>
                <div class="card-subtitle">Format Organizer</div>
                <div class="tooltip">Different schemas, protocols, error formats ¬∑ Translate request ‚Üí canonical ¬∑ Translate response ‚Üí canonical ¬∑ Map error codes ¬∑ Handle versioning</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Identity / Auth detail page (separate view) -->
    <div id="view-identity" class="diagram-view hidden">
      <div class="orch-page identity-page">
        <div class="orch-page-bar identity-page-bar">
          <button type="button" class="back-btn identity-back-btn" id="backFromIdentityBtn" aria-label="Back to overall diagram">
            ‚Üê Back to overall
          </button>
          <span class="orch-page-title identity-page-title">Authentication &amp; Authorization Service</span>
        </div>
        <div class="orch-page-content">
          <div class="interaction-legend">
            <div class="legend-title">üîê Identity services</div>
            <div class="legend-item"><span class="legend-arrow">‚Üí</span> Services connected and running under Authentication &amp; Authorization</div>
          </div>

          <div class="service-category">
            <div class="category-title">Citizen Identity</div>
            <div class="services-grid">
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">ü™™</div>
                <div class="card-title">VeriFayda 2.0</div>
                <div class="card-subtitle">National biometric identity</div>
                <div class="tooltip">National biometric identity verification for Ethiopian citizens</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/verifayda</div>
              </div>
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üîë</div>
                <div class="card-title">Local Auth</div>
                <div class="card-subtitle">Email / password, OTP MFA</div>
                <div class="tooltip">Email/password login, OTP-based MFA, foreign national support</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/login</div>
              </div>
            </div>
          </div>

          <div class="service-category">
            <div class="category-title">Token &amp; Access Control</div>
            <div class="services-grid">
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üîÑ</div>
                <div class="card-title">Token Management</div>
                <div class="card-subtitle">JWT, refresh, revocation</div>
                <div class="tooltip">JWT issuance, refresh, revocation, and role-based access control</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/v2/auth/token</div>
              </div>
              <div class="card identity-service-card">
                <span class="service-badge"></span>
                <div class="card-icon">üõ°Ô∏è</div>
                <div class="card-title">Admin Auth + MFA</div>
                <div class="card-subtitle">Privileged access</div>
                <div class="tooltip">Enhanced MFA for administrative operations and privileged access</div>
                <div style="margin-top:8px; font-family: monospace; font-size: 10px; color: var(--text-secondary);">/api/v2/admin</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme Toggle Logic
      const themeBtn = document.getElementById('themeBtn');
      const html = document.documentElement;

      themeBtn.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        drawConnections(); // Redraw lines for new colors
      });

      // Navigate between views
      const viewOverall = document.getElementById('view-overall');
      const viewOrchestration = document.getElementById('view-orchestration');
      const viewIdentity = document.getElementById('view-identity');
      const orchCore = document.getElementById('orch-core');
      const orchId = document.getElementById('orch-id');
      const backToOverallBtn = document.getElementById('backToOverallBtn');
      const backFromIdentityBtn = document.getElementById('backFromIdentityBtn');

      function showOrchestrationPage() {
        viewOverall.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewOrchestration.classList.remove('hidden');
        setTimeout(drawOrchConnections, 200);
      }

      function showIdentityPage() {
        viewOverall.classList.add('hidden');
        viewOrchestration.classList.add('hidden');
        viewIdentity.classList.remove('hidden');
      }

      function showOverallPage() {
        viewOrchestration.classList.add('hidden');
        viewIdentity.classList.add('hidden');
        viewOverall.classList.remove('hidden');
      }

      orchCore.addEventListener('click', (e) => {
        e.stopPropagation();
        showOrchestrationPage();
      });

      if (orchId) {
        orchId.addEventListener('click', (e) => {
          e.stopPropagation();
          showIdentityPage();
        });
      }

      if (backToOverallBtn) {
        backToOverallBtn.addEventListener('click', showOverallPage);
      }
      if (backFromIdentityBtn) {
        backFromIdentityBtn.addEventListener('click', showOverallPage);
      }

      // Draw connection lines between services on orchestration page
      function drawOrchConnections() {
        const svg = document.getElementById('orchConnectionsSvg');
        const container = document.querySelector('.orch-page-content');
        if (!svg || !container) return;
        const rect = container.getBoundingClientRect();
        svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        svg.setAttribute('width', rect.width);
        svg.setAttribute('height', rect.height);
        const cards = container.querySelectorAll('.card[data-service][data-connects-to]');
        const idToPos = new Map();
        cards.forEach(card => {
          const r = card.getBoundingClientRect();
          const cx = r.left - rect.left + r.width / 2;
          const cy = r.top - rect.top + r.height / 2;
          idToPos.set(card.getAttribute('data-service'), { x: cx, y: cy });
        });
        const drawn = new Set();
        let pathD = '';
        cards.forEach(card => {
          const fromId = card.getAttribute('data-service');
          const toIds = (card.getAttribute('data-connects-to') || '').split(',');
          const from = idToPos.get(fromId);
          if (!from) return;
          toIds.forEach(toId => {
            const key = [fromId, toId.trim()].sort().join('-');
            if (drawn.has(key)) return;
            const to = idToPos.get(toId.trim());
            if (!to) return;
            drawn.add(key);
            const midX = (from.x + to.x) / 2;
            pathD += `M ${from.x} ${from.y} C ${midX} ${from.y}, ${midX} ${to.y}, ${to.x} ${to.y} `;
          });
        });
        svg.innerHTML = '<path d="' + pathD + '" fill="none" stroke-width="1.5" opacity="0.35"/>';
      }

      // Service connection highlighting (hover) on orchestration page
      function setupServiceInteractions() {
        const serviceCards = document.querySelectorAll('.orch-page .card[data-service]');
        serviceCards.forEach(card => {
          card.addEventListener('mouseenter', () => {
            card.classList.add('highlighted');
            const connectsTo = card.getAttribute('data-connects-to');
            if (connectsTo) {
              connectsTo.split(',').forEach(connectedId => {
                const connectedCard = document.querySelector(`.orch-page .card[data-service="${connectedId.trim()}"]`);
                if (connectedCard) connectedCard.classList.add('highlighted');
              });
            }
          });
          card.addEventListener('mouseleave', () => {
            serviceCards.forEach(c => c.classList.remove('highlighted'));
          });
        });
      }
      setupServiceInteractions();

      // Connection Drawing Logic
      function drawLine(svg, startElem, endElem, colorClass) {
        const startRect = startElem.getBoundingClientRect();
        const endRect = endElem.getBoundingClientRect();
        const containerRect = document.querySelector('.architecture-container').getBoundingClientRect();

        // Calculate relative coordinates
        const x1 = startRect.left + startRect.width / 2 - containerRect.left;
        const y1 = startRect.top - containerRect.top; // Top of start element
        const x2 = endRect.left + endRect.width / 2 - containerRect.left;
        const y2 = endRect.bottom - containerRect.top; // Bottom of end element (since we draw bottom-up visual but code is top-down logic usually, let's adjust)

        // Actually, we want lines from bottom layers UP to top layers.
        // Start: Top of bottom element
        // End: Bottom of top element

        // Let's redefine: startElem is the LOWER element, endElem is the UPPER element
        const startX = startRect.left + startRect.width / 2 - containerRect.left;
        const startY = startRect.top - containerRect.top; // Top edge of lower card

        const endX = endRect.left + endRect.width / 2 - containerRect.left;
        const endY = endRect.bottom - containerRect.top; // Bottom edge of upper card

        // Create Path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

        // Bezier curve control points
        const controlY1 = startY - 30;
        const controlY2 = endY + 30;

        const d = `M ${startX} ${startY} C ${startX} ${controlY1}, ${endX} ${controlY2}, ${endX} ${endY}`;

        path.setAttribute('d', d);
        path.classList.add('connector-flow');
        // path.setAttribute("marker-end", "url(#arrowhead)"); // Optional arrow

        svg.appendChild(path);
      }

      function drawConnections() {
        const svg = document.getElementById('svgLayer');
        svg.innerHTML = ''; // Clear previous lines

        const springGw = document.getElementById('spring-cloud-gw');
        const apiSixGw = document.getElementById('api-gw');
        const instIds = ['inst-dars', 'inst-mor', 'inst-nid', 'inst-motri'];
        const msIds = ['ms-dars', 'ms-mor', 'ms-nid', 'ms-motri'];
        const orchCore = document.getElementById('orch-core');
        const uiMobile = document.getElementById('ui-mobile');
        const uiWeb = document.getElementById('ui-web');

        // 1. Institutions -> API Six Gateway (organizations side)
        instIds.forEach((id) => {
          const inst = document.getElementById(id);
          if (inst && apiSixGw) drawLine(svg, inst, apiSixGw);
        });

        // 2. API Six Gateway -> Microservices
        msIds.forEach((id) => {
          const ms = document.getElementById(id);
          if (apiSixGw && ms) drawLine(svg, apiSixGw, ms);
        });

        // 3. Microservices -> Orchestration Core
        msIds.forEach((id) => {
          const ms = document.getElementById(id);
          if (ms && orchCore) drawLine(svg, ms, orchCore);
        });

        // 4. Orchestration Core -> Spring Cloud Gateway (public side)
        if (orchCore && springGw) drawLine(svg, orchCore, springGw);

        // 5. Spring Cloud Gateway -> Identity Mgmt & Notification
        const orchId = document.getElementById('orch-id');
        const orchNotif = document.getElementById('orch-notif');
        if (springGw && orchId) drawLine(svg, springGw, orchId);
        if (springGw && orchNotif) drawLine(svg, springGw, orchNotif);

        // 6. Spring Cloud Gateway -> UI (Mobile, Web, Kiosk, USSD)
        const uiKiosk = document.getElementById('ui-kiosk');
        const uiUssd = document.getElementById('ui-ussd');
        if (springGw && uiMobile) drawLine(svg, springGw, uiMobile);
        if (springGw && uiWeb) drawLine(svg, springGw, uiWeb);
        if (springGw && uiKiosk) drawLine(svg, springGw, uiKiosk);
        if (springGw && uiUssd) drawLine(svg, springGw, uiUssd);
      }

      // Handle resize
      window.addEventListener('resize', drawConnections);

      // Initial Draw
      // Small delay to ensure layout is done
      setTimeout(drawConnections, 100);
    </script>
  

</body></html>